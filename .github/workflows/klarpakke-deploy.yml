name: Klarpakke Deploy (staging/prod)

on:
  # 1-click from UI or CLI
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        type: choice
        required: true
        default: staging
        options:
          - staging
          - production

  # Auto staging deploy on merge to main
  push:
    branches: [ main ]

concurrency:
  group: klarpakke-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy_staging:
    name: Deploy staging
    if: ${{ github.event_name == 'push' || github.event.inputs.target == 'staging' || github.event.inputs.target == 'production' }}
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Preflight (staging)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          WEBFLOW_API_TOKEN: ${{ secrets.WEBFLOW_API_TOKEN }}
          WEBFLOW_SITE_ID: ${{ secrets.WEBFLOW_SITE_ID }}
          WEBFLOW_CUSTOM_CODE_HEAD: ${{ secrets.WEBFLOW_CUSTOM_CODE_HEAD }}
          WEBFLOW_CUSTOM_CODE_FOOTER: ${{ secrets.WEBFLOW_CUSTOM_CODE_FOOTER }}
          WEBFLOW_STAGING_DOMAIN_ID: ${{ secrets.WEBFLOW_STAGING_DOMAIN_ID }}
          STAGING_HEALTHCHECK_URL: ${{ secrets.STAGING_HEALTHCHECK_URL }}
        run: |
          set -euo pipefail

          required=(
            SUPABASE_ACCESS_TOKEN
            SUPABASE_PROJECT_ID
            SUPABASE_URL
            SUPABASE_ANON_KEY
            SUPABASE_SERVICE_ROLE_KEY
            WEBFLOW_API_TOKEN
            WEBFLOW_SITE_ID
            WEBFLOW_CUSTOM_CODE_HEAD
            WEBFLOW_CUSTOM_CODE_FOOTER
            WEBFLOW_STAGING_DOMAIN_ID
            STAGING_HEALTHCHECK_URL
          )

          missing=0
          for k in "${required[@]}"; do
            if [ -z "${!k:-}" ]; then
              echo "::error::Missing required secret/env: $k"
              missing=1
            fi
          done
          [ "$missing" -eq 0 ]

          command -v jq >/dev/null || (echo "::error::jq not found" && exit 1)
          command -v curl >/dev/null || (echo "::error::curl not found" && exit 1)

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Supabase CLI
        run: npm i -g supabase

      - name: Deploy Supabase Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          set -euo pipefail
          supabase link --project-ref "$SUPABASE_PROJECT_ID"

          if [ -d "supabase/functions" ]; then
            for dir in supabase/functions/*; do
              [ -d "$dir" ] || continue
              fn="$(basename "$dir")"
              case "$fn" in
                _*|.*) continue ;;
              esac
              echo "Deploying function: $fn"
              supabase functions deploy "$fn" --project-ref "$SUPABASE_PROJECT_ID"
            done
          else
            echo "No supabase/functions directory found; skipping edge deploy."
          fi

      - name: Set Supabase secrets for functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euo pipefail
          supabase secrets set \
            --project-ref "$SUPABASE_PROJECT_ID" \
            SUPABASE_URL="$SUPABASE_URL" \
            SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY" \
            SUPABASE_SERVICE_ROLE_KEY="$SUPABASE_SERVICE_ROLE_KEY"

      - name: Update Webflow custom code (site-wide)
        env:
          WEBFLOW_API_TOKEN: ${{ secrets.WEBFLOW_API_TOKEN }}
          WEBFLOW_SITE_ID: ${{ secrets.WEBFLOW_SITE_ID }}
          WEBFLOW_CUSTOM_CODE_HEAD: ${{ secrets.WEBFLOW_CUSTOM_CODE_HEAD }}
          WEBFLOW_CUSTOM_CODE_FOOTER: ${{ secrets.WEBFLOW_CUSTOM_CODE_FOOTER }}
        run: |
          set -euo pipefail
          body=$(jq -n --arg head "$WEBFLOW_CUSTOM_CODE_HEAD" --arg footer "$WEBFLOW_CUSTOM_CODE_FOOTER" '{headCode:$head, footerCode:$footer}')
          curl -fsS -X PUT "https://api.webflow.com/v2/sites/${WEBFLOW_SITE_ID}/custom_code" \
            -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$body"

      - name: Publish Webflow (staging domain)
        env:
          WEBFLOW_API_TOKEN: ${{ secrets.WEBFLOW_API_TOKEN }}
          WEBFLOW_SITE_ID: ${{ secrets.WEBFLOW_SITE_ID }}
          WEBFLOW_STAGING_DOMAIN_ID: ${{ secrets.WEBFLOW_STAGING_DOMAIN_ID }}
        run: |
          set -euo pipefail
          curl -fsS -X POST "https://api.webflow.com/v2/sites/${WEBFLOW_SITE_ID}/publish" \
            -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"domains":["'"$WEBFLOW_STAGING_DOMAIN_ID"'"]}'

      - name: Public healthcheck
        env:
          HEALTHCHECK_URL: ${{ secrets.STAGING_HEALTHCHECK_URL }}
        run: |
          set -euo pipefail
          curl -fsS "$HEALTHCHECK_URL" >/dev/null

  deploy_production:
    name: Deploy production
    if: ${{ github.event.inputs.target == 'production' }}
    runs-on: ubuntu-latest
    needs: [deploy_staging]
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Preflight (production)
        env:
          WEBFLOW_API_TOKEN: ${{ secrets.WEBFLOW_API_TOKEN }}
          WEBFLOW_SITE_ID: ${{ secrets.WEBFLOW_SITE_ID }}
          WEBFLOW_PROD_DOMAIN_IDS_JSON: ${{ secrets.WEBFLOW_PROD_DOMAIN_IDS_JSON }}
          PROD_HEALTHCHECK_URL: ${{ secrets.PROD_HEALTHCHECK_URL }}
        run: |
          set -euo pipefail

          required=(WEBFLOW_API_TOKEN WEBFLOW_SITE_ID WEBFLOW_PROD_DOMAIN_IDS_JSON PROD_HEALTHCHECK_URL)
          missing=0
          for k in "${required[@]}"; do
            if [ -z "${!k:-}" ]; then
              echo "::error::Missing required secret/env: $k"
              missing=1
            fi
          done
          [ "$missing" -eq 0 ]

          # Validate that WEBFLOW_PROD_DOMAIN_IDS_JSON is a JSON array of strings
          echo "$WEBFLOW_PROD_DOMAIN_IDS_JSON" | jq -e 'type=="array" and all(.[]; type=="string")' >/dev/null

      - name: Publish Webflow (production domains)
        env:
          WEBFLOW_API_TOKEN: ${{ secrets.WEBFLOW_API_TOKEN }}
          WEBFLOW_SITE_ID: ${{ secrets.WEBFLOW_SITE_ID }}
          WEBFLOW_PROD_DOMAIN_IDS_JSON: ${{ secrets.WEBFLOW_PROD_DOMAIN_IDS_JSON }}
        run: |
          set -euo pipefail
          # WEBFLOW_PROD_DOMAIN_IDS_JSON must be like: ["domainId1","domainId2"]
          curl -fsS -X POST "https://api.webflow.com/v2/sites/${WEBFLOW_SITE_ID}/publish" \
            -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --argjson domains "$WEBFLOW_PROD_DOMAIN_IDS_JSON" '{domains:$domains}')"

      - name: Public healthcheck
        env:
          HEALTHCHECK_URL: ${{ secrets.PROD_HEALTHCHECK_URL }}
        run: |
          set -euo pipefail
          curl -fsS "$HEALTHCHECK_URL" >/dev/null
