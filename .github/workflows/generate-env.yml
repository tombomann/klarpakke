name: ðŸ” Generate .env from Secrets

on:
  workflow_dispatch:
    inputs:
      include_all:
        description: 'Include all secrets (not just Supabase)'
        required: false
        type: boolean
        default: false

jobs:
  generate-env:
    name: ðŸ“¦ Generate .env file
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ” Generate .env from Secrets
        env:
          # Supabase (required)
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          
          # Optional: All other secrets
          PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}
          WEBFLOW_API_TOKEN: ${{ secrets.WEBFLOW_API_TOKEN }}
          WEBFLOW_SITE_ID: ${{ secrets.WEBFLOW_SITE_ID }}
          WEBFLOW_COLLECTION_ID: ${{ secrets.WEBFLOW_COLLECTION_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          MAKE_API_TOKEN: ${{ secrets.MAKE_API_TOKEN }}
          MAKE_TEAM_ID: ${{ secrets.MAKE_TEAM_ID }}
          
        run: |
          echo "ðŸ” Generating .env from GitHub Secrets..."
          echo ""
          
          cat > .env << 'EOF'
          # ===========================================
          # Klarpakke Environment Configuration
          # Generated from GitHub Secrets
          # Date: $(date)
          # ===========================================
          
          # ===== SUPABASE CONFIGURATION =====
          SUPABASE_PROJECT_REF=${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN=${{ secrets.SUPABASE_ACCESS_TOKEN }}
          
          # ===== WEBFLOW CONFIGURATION =====
          WEBFLOW_API_TOKEN=${{ secrets.WEBFLOW_API_TOKEN }}
          WEBFLOW_SITE_ID=${{ secrets.WEBFLOW_SITE_ID }}
          WEBFLOW_COLLECTION_ID=${{ secrets.WEBFLOW_COLLECTION_ID }}
          
          # ===== AI/API KEYS =====
          PPLX_API_KEY=${{ secrets.PPLX_API_KEY }}
          
          # ===== DATABASE =====
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          # ===== PAYMENT =====
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          
          # ===== MAKE.COM =====
          MAKE_API_TOKEN=${{ secrets.MAKE_API_TOKEN }}
          MAKE_TEAM_ID=${{ secrets.MAKE_TEAM_ID }}
          EOF
          
          echo "âœ“ .env file generated"
          echo ""
          
          # Validate
          echo "ðŸ“Š Validating required Supabase variables..."
          
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "âŒ Missing: SUPABASE_PROJECT_REF"
            exit 1
          else
            echo "  âœ“ SUPABASE_PROJECT_REF: ${SUPABASE_PROJECT_REF}"
          fi
          
          if [ -z "$SUPABASE_URL" ]; then
            echo "âŒ Missing: SUPABASE_URL"
            exit 1
          else
            echo "  âœ“ SUPABASE_URL: ${SUPABASE_URL}"
          fi
          
          if [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "âŒ Missing: SUPABASE_ANON_KEY"
            exit 1
          else
            echo "  âœ“ SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:0:20}..."
          fi
          
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "âŒ Missing: SUPABASE_SERVICE_ROLE_KEY"
            exit 1
          else
            echo "  âœ“ SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:0:20}..."
          fi
          
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "âŒ Missing: SUPABASE_ACCESS_TOKEN"
            exit 1
          else
            echo "  âœ“ SUPABASE_ACCESS_TOKEN: ${SUPABASE_ACCESS_TOKEN:0:10}..."
          fi
          
          echo ""
          echo "âœ… All required Supabase variables present!"
      
      - name: ðŸ“¤ Upload .env as artifact
        uses: actions/upload-artifact@v4
        with:
          name: env-file
          path: .env
          retention-days: 1
      
      - name: ðŸ“‹ Instructions
        run: |
          echo ""
          echo "====================================="
          echo "âœ… .env file generated successfully!"
          echo "====================================="
          echo ""
          echo "ðŸ“¥ Download .env file:"
          echo "1. Go to Actions tab"
          echo "2. Click this workflow run"
          echo "3. Download 'env-file' artifact"
          echo "4. Unzip and move .env to project root"
          echo ""
          echo "Or use GitHub CLI:"
          echo "  gh run download --name env-file"
          echo "  mv env-file/.env ."
          echo ""
          echo "ðŸš€ Next steps:"
          echo "  npm run ci:all"
          echo "  gh workflow run 'ðŸš€ Auto-Deploy Pipeline' --ref main -f environment=staging"
          echo ""
