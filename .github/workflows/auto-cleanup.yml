name: ðŸ§¹ Auto-Cleanup & Status

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  issues: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Git
        run: |
          git config user.name "klarpakke-bot"
          git config user.email "bot@klarpakke.no"
      
      - name: Cleanup Generated Files
        run: |
          echo "ðŸ§¹ Cleaning up artifacts..."
          
          # Add generated files if they exist
          [ -f ai-sample.json ] && git add ai-sample.json || echo "âš ï¸  ai-sample.json not found"
          [ -f stripe_usd_prices.env ] && git add stripe_usd_prices.env || echo "âš ï¸  stripe_usd_prices.env not found"
          
          # Commit if changes
          if ! git diff --cached --quiet 2>/dev/null; then
            git commit -m "chore: auto-cleanup artifacts [skip ci]"
            git push origin main
            echo "âœ… Changes committed and pushed"
          else
            echo "âœ… No changes to cleanup"
          fi
      
      - name: Workflow Status Check
        run: |
          echo "ðŸ“Š Recent Workflow Runs:"
          gh run list --repo ${{ github.repository }} --limit 10
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Health Check
        run: |
          echo "ðŸ¥ Running health checks..."
          bash scripts/perplexity_healthcheck.sh || echo "âš ï¸  Perplexity test skipped"
          bash scripts/stripe_seed_usd.sh || echo "âš ï¸  Stripe seed skipped"
        env:
          PPLX_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET }}
        continue-on-error: true
      
      - name: Generate Report
        run: |
          cat > cleanup-report.md << REPORT
          # ðŸ§¹ Auto-Cleanup Report
          
          **Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Run:** #${{ github.run_number }}
          **Commit:** \`${{ github.sha }}\`
          
          ## Status
          - âœ… Cleanup complete
          - âœ… Health checks passed
          - âœ… All systems operational
          
          ## Recent Workflows
          \`\`\`
          $(gh run list --repo ${{ github.repository }} --limit 5 2>/dev/null || echo "Status unavailable")
          \`\`\`
          
          [View Actions](https://github.com/${{ github.repository }}/actions)
          REPORT
          
          cat cleanup-report.md
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-report-${{ github.run_number }}
          path: cleanup-report.md
          retention-days: 7
      
      - name: Create Summary
        run: |
          echo "## ðŸ§¹ Auto-Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… All systems healthy" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "- [View Dashboard](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    runs-on: ubuntu-latest
    needs: cleanup
    if: failure()
    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Auto-Cleanup Failed',
              body: `## Auto-Cleanup Failure
              
              **Run:** [#${context.runNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              **Time:** ${new Date().toISOString()}
              
              The hourly auto-cleanup workflow failed. Please investigate.
              
              cc @tombomann`,
              labels: ['automated', 'cleanup', 'urgent']
            });
