name: ğŸš€ Deploy Klarpakke

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SUPABASE_PROJECT_REF: swfyuwkptusceiouqlks

jobs:
  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate scripts
        run: |
          bash -n scripts/*.sh
          echo "âœ… All scripts are valid"
      
      - name: Check Edge Functions syntax
        run: |
          if command -v deno &> /dev/null; then
            for func in supabase/functions/*/index.ts; do
              deno check "$func" || echo "Skipping $func"
            done
          else
            echo "Deno not installed, skipping syntax check"
          fi

  deploy-backend:
    name: ğŸ“¦ Deploy Backend
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Link Supabase project
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Deploy Edge Functions
        run: |
          for func in supabase/functions/*/; do
            func_name=$(basename "$func")
            echo "Deploying $func_name..."
            supabase functions deploy "$func_name" --no-verify-jwt
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Apply database migrations
        run: |
          if [ -d "supabase/migrations" ]; then
            supabase db push
          else
            echo "No migrations to apply"
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Set secrets
        run: |
          supabase secrets set SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}" \
            PERPLEXITY_API_KEY="${{ secrets.PPLX_API_KEY }}" \
            --project-ref ${{ env.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Test Edge Function
        run: |
          RESPONSE=$(curl -s -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/debug-env" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"test": true}')
          
          if echo "$RESPONSE" | jq -e '.SUPABASE_URL' >/dev/null 2>&1; then
            echo "âœ… Supabase Edge Functions: OK"
          else
            echo "âŒ Supabase Edge Functions: FAILED"
            echo "Response: $RESPONSE"
            exit 1
          fi
      
      - name: Check signals count
        run: |
          COUNT=$(curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/signals?select=count" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            | jq -r '.[0].count // 0')
          
          echo "ğŸ“Š Signals in database: $COUNT"
          
          if [ "$COUNT" -gt 0 ]; then
            echo "âœ… Database: OK ($COUNT signals)"
          else
            echo "âš ï¸  Database: Empty (seed data with scripts/paper-seed.sh)"
          fi

  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [deploy-backend, verify]
    if: always()
    steps:
      - name: Deployment summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ‰ KLARPAKKE DEPLOYMENT COMPLETE              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ Live URLs:"
          echo "  â€¢ Dashboard: https://klarpakke-c65071.webflow.io/app/dashboard"
          echo "  â€¢ Calculator: https://klarpakke-c65071.webflow.io/kalkulator"
          echo "  â€¢ API: https://swfyuwkptusceiouqlks.supabase.co"
          echo ""
          echo "ğŸ“Š Deployment Status: ${{ needs.verify.result }}"
