name: üîê Secrets Audit

on:
  schedule:
    - cron: '0 12 * * 1'  # Every Monday at noon
  workflow_dispatch:

jobs:
  audit:
    name: Audit Secrets Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate secrets
        run: |
          echo "üîç Checking secrets configuration..."
          
          # Check if all required secrets are set
          REQUIRED_SECRETS=(
            "SUPABASE_URL"
            "SUPABASE_ANON_KEY"
            "WEBFLOW_API_TOKEN"
            "WEBFLOW_SIGNALS_COLLECTION_ID"
          )
          
          MISSING=0
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if [ -z "${!secret}" ]; then
              echo "‚ùå Missing: $secret"
              MISSING=$((MISSING+1))
            else
              echo "‚úÖ Found: $secret"
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo "‚ùå $MISSING secrets missing!"
            exit 1
          else
            echo "‚úÖ All secrets configured!"
          fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          WEBFLOW_API_TOKEN: ${{ secrets.WEBFLOW_API_TOKEN }}
          WEBFLOW_SIGNALS_COLLECTION_ID: ${{ secrets.WEBFLOW_SIGNALS_COLLECTION_ID }}
      
      - name: Test API connections
        run: |
          echo "üß™ Testing API connections..."
          
          # Test Supabase
          SUPABASE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            "$SUPABASE_URL/rest/v1/")
          
          if [ "$SUPABASE_STATUS" = "200" ]; then
            echo "‚úÖ Supabase API: Connected"
          else
            echo "‚ùå Supabase API: Failed (HTTP $SUPABASE_STATUS)"
            exit 1
          fi
          
          # Test Webflow
          WEBFLOW_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $WEBFLOW_API_TOKEN" \
            "https://api.webflow.com/v2/sites/$WEBFLOW_SITE_ID")
          
          if [ "$WEBFLOW_STATUS" = "200" ]; then
            echo "‚úÖ Webflow API: Connected"
          else
            echo "‚ùå Webflow API: Failed (HTTP $WEBFLOW_STATUS)"
            exit 1
          fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          WEBFLOW_API_TOKEN: ${{ secrets.WEBFLOW_API_TOKEN }}
          WEBFLOW_SITE_ID: ${{ secrets.WEBFLOW_SITE_ID }}
