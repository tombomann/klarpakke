name: ğŸš€ Auto-Deploy Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'web/**'
      - 'supabase/**'
      - 'scripts/deploy-*.sh'
      - 'package.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy target'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_webflow:
        description: 'Skip Webflow deployment'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  SUPABASE_CLI_VERSION: latest

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. LINT & BUILD (all branches)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint-and-build:
    name: ğŸ“‹ Lint & Build Web Assets
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ” Lint web scripts
        run: |
          echo "âœ“ Checking JS syntax..."
          node -c web/klarpakke-site.js
          node -c web/calculator.js
          node -c web/klarpakke-ui.js
          echo "âœ“ All JS files valid"

      - name: ğŸ—ï¸ Build web bundles
        run: npm run build:web

      - name: ğŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-bundles
          path: web/dist/
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. SUPABASE SETUP (database + migrations)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  supabase-deploy:
    name: ğŸ—„ï¸ Deploy Supabase (DB + Functions)
    runs-on: ubuntu-latest
    needs: lint-and-build
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Verify Supabase secrets
        run: |
          if [[ -z "$SUPABASE_ACCESS_TOKEN" ]]; then
            echo "âŒ ERROR: SUPABASE_ACCESS_TOKEN not set in Secrets"
            exit 1
          fi
          if [[ -z "${{ secrets.SUPABASE_PROJECT_REF }}" ]]; then
            echo "âŒ ERROR: SUPABASE_PROJECT_REF not set in Secrets"
            exit 1
          fi
          echo "âœ“ Secrets found"

      - name: ğŸ”§ Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”‘ Link Supabase project
        run: |
          PROJECT_REF="$(echo -n "${{ secrets.SUPABASE_PROJECT_REF }}" | tr -d '[:space:]')"
          echo "Cleaned Project Ref: ${PROJECT_REF:0:5}..."
          echo "Length: ${#PROJECT_REF} chars"
          
          if [[ ! "$PROJECT_REF" =~ ^[a-z0-9]{20}$ ]]; then
            echo "âŒ ERROR: Invalid PROJECT_REF format!"
            echo "   Expected: 20 alphanumeric characters (lowercase letters + digits)"
            echo "   Example: 'swfyuwkptusceiouqlks'"
            echo "   Got: '$PROJECT_REF' (${#PROJECT_REF} chars)"
            exit 1
          fi
          
          echo "âœ“ Project Ref validated: ${PROJECT_REF:0:5}..."
          supabase link --project-ref "$PROJECT_REF"

      - name: ğŸ“ Show pending migrations
        run: supabase migration list
        continue-on-error: true

      - name: ğŸš€ Deploy migrations
        run: |
          if [[ -d supabase/migrations ]]; then
            echo "Deploying migrations..."
            supabase db push --linked
          else
            echo "No migrations found, skipping"
          fi
        continue-on-error: true

      - name: ğŸ“¤ Deploy Edge Functions
        run: bash scripts/deploy-functions.sh
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. WEBFLOW DEPLOY (automatic via API v2/v1)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  webflow-deploy:
    name: ğŸ¨ Deploy to Webflow
    runs-on: ubuntu-latest
    needs: [lint-and-build, supabase-deploy]
    if: ${{ !inputs.skip_webflow }}
    env:
      WEBFLOW_API_TOKEN: ${{ secrets.WEBFLOW_API_TOKEN }}
      WEBFLOW_SITE_ID: ${{ secrets.WEBFLOW_SITE_ID }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ“š Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ğŸ“¥ Download web bundles
        uses: actions/download-artifact@v4
        with:
          name: web-bundles
          path: web/dist/

      - name: ğŸ” Verify Webflow secrets
        run: |
          if [[ -z "$WEBFLOW_API_TOKEN" ]]; then
            echo "âŒ ERROR: WEBFLOW_API_TOKEN not set in Secrets"
            exit 1
          fi
          if [[ -z "$WEBFLOW_SITE_ID" ]]; then
            echo "âŒ ERROR: WEBFLOW_SITE_ID not set in Secrets"
            exit 1
          fi
          echo "âœ“ Webflow secrets OK"

      - name: ğŸš€ Deploy to Webflow (v2 with v1 fallback)
        run: |
          set -e
          
          echo "ğŸ¨ Generating Webflow loader..."
          
          # Generate inline loader (raw HTML for footer)
          LOADER_HTML='<script>
          (function() {
            "use strict";
            window.KLARPAKKE_CONFIG = {
              supabaseUrl: "${{ secrets.SUPABASE_URL }}",
              supabaseAnonKey: "${{ secrets.SUPABASE_ANON_KEY }}",
              version: "${{ github.sha }}",
              debug: false
            };
            console.log("[Klarpakke] Config loaded", window.KLARPAKKE_CONFIG.version);
            const CDN = "https://cdn.jsdelivr.net/gh/tombomann/klarpakke@${{ github.sha }}/web/dist";
            function loadScript(src, name) {
              const s = document.createElement("script");
              s.src = src;
              s.async = true;
              s.onload = () => console.log("[Klarpakke] " + name + " loaded");
              s.onerror = () => console.error("[Klarpakke] Failed: " + name);
              document.body.appendChild(s);
            }
            loadScript(CDN + "/klarpakke-site.js", "Main");
            if (window.location.pathname.includes("/kalkulator")) {
              loadScript(CDN + "/calculator.js", "Calculator");
            }
          })();
          </script>'
          
          echo "ğŸ“¤ Attempting Webflow API v2 deployment..."
          
          # Escape for JSON (simple approach for this specific case)
          LOADER_JSON=$(printf '%s' "$LOADER_HTML" | jq -Rs '.')
          
          # v2 API payload (correct structure: headCode + footerCode)
          V2_PAYLOAD=$(jq -n \
            --arg footer "$LOADER_HTML" \
            '{headCode: "", footerCode: $footer}')
          
          echo "Payload preview (first 200 chars):"
          echo "$V2_PAYLOAD" | head -c 200
          echo ""
          
          # Try v2 API first
          echo "Calling v2 API endpoint..."
          V2_RESPONSE=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" -X PUT \
            "https://api.webflow.com/v2/sites/${WEBFLOW_SITE_ID}/custom_code" \
            -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$V2_PAYLOAD" 2>&1) || V2_RESPONSE="CURL_ERROR:$?"
          
          HTTP_CODE=$(echo "$V2_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2 || echo "000")
          RESPONSE_BODY=$(echo "$V2_RESPONSE" | sed '/HTTP_STATUS:/d')
          
          # Check if v2 succeeded (200 or 204)
          if [[ "$HTTP_CODE" =~ ^(200|204)$ ]]; then
            echo "âœ… Custom Code updated via API v2"
            API_VERSION="v2"
          # Check if it's a version authorization error
          elif [[ "$HTTP_CODE" == "403" ]] && echo "$RESPONSE_BODY" | grep -qi "not authorized.*version\|invalid_auth_version"; then
            echo "âš ï¸  Token not authorized for v2 API"
            echo "    Error: $RESPONSE_BODY"
            echo "ğŸ”„ Falling back to API v1..."
            
            # v1 API payload (different structure + different endpoint)
            V1_PAYLOAD=$(jq -n \
              --arg footer "$LOADER_HTML" \
              '{customCode: {footer: $footer}}')
            
            # Try v1 API (different endpoint: /sites/{id} not /sites/{id}/custom_code)
            echo "Calling v1 API endpoint..."
            V1_RESPONSE=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" -X PUT \
              "https://api.webflow.com/sites/${WEBFLOW_SITE_ID}" \
              -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -H "accept-version: 1.0.0" \
              -d "$V1_PAYLOAD" 2>&1)
            
            V1_HTTP_CODE=$(echo "$V1_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2 || echo "000")
            V1_RESPONSE_BODY=$(echo "$V1_RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [[ "$V1_HTTP_CODE" =~ ^(200|204)$ ]]; then
              echo "âœ… Custom Code updated via API v1 (legacy)"
              echo ""
              echo "âš ï¸  MIGRATION RECOMMENDED:"
              echo "   Your token only supports v1 API (deprecated)"
              echo "   Generate a new Site Token with v2 access:"
              echo "   https://developers.webflow.com/data/docs/getting-started"
              API_VERSION="v1"
            else
              echo "âŒ Both v2 and v1 API calls failed!"
              echo ""
              echo "v2 Response (HTTP $HTTP_CODE):"
              echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
              echo ""
              echo "v1 Response (HTTP $V1_HTTP_CODE):"
              echo "$V1_RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$V1_RESPONSE_BODY"
              exit 1
            fi
          else
            echo "âŒ Unexpected error from Webflow API v2 (HTTP $HTTP_CODE):"
            echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
            exit 1
          fi
          
          echo ""
          echo "ğŸ“£ Publishing Webflow site..."
          
          # Publish (different endpoints for v1/v2)
          if [[ "$API_VERSION" == "v2" ]]; then
            echo "Using v2 publish endpoint..."
            PUBLISH_RESPONSE=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" -X POST \
              "https://api.webflow.com/v2/sites/${WEBFLOW_SITE_ID}/publish" \
              -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{}' 2>&1)
            
            PUB_HTTP_CODE=$(echo "$PUBLISH_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2 || echo "000")
            PUB_BODY=$(echo "$PUBLISH_RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [[ "$PUB_HTTP_CODE" =~ ^(200|202)$ ]]; then
              echo "âœ… Site published (v2)"
              echo "$PUB_BODY" | jq -r '.publishedAt // "Queued"' 2>/dev/null || echo "Published"
            else
              echo "âš ï¸  Publish may have failed (v2):"
              echo "$PUB_BODY" | jq '.' 2>/dev/null || echo "$PUB_BODY"
            fi
          else
            # v1 publish
            echo "Using v1 publish endpoint..."
            PUBLISH_RESPONSE=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" -X POST \
              "https://api.webflow.com/sites/${WEBFLOW_SITE_ID}/publish" \
              -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
              -H "accept-version: 1.0.0" 2>&1)
            
            PUB_HTTP_CODE=$(echo "$PUBLISH_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2 || echo "000")
            PUB_BODY=$(echo "$PUBLISH_RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [[ "$PUB_HTTP_CODE" =~ ^(200|202)$ ]]; then
              echo "âœ… Site published (v1)"
            else
              echo "âš ï¸  Publish response (v1):"
              echo "$PUB_BODY" | jq '.' 2>/dev/null || echo "$PUB_BODY"
            fi
          fi
          
          echo ""
          echo "ğŸ‰ Webflow deployment complete!"
          echo "   API Version: $API_VERSION"
          echo "   Commit: ${{ github.sha }}"
          echo "   CDN: https://cdn.jsdelivr.net/gh/tombomann/klarpakke@${{ github.sha }}/web/dist"

      - name: ğŸ“Š Generate Webflow Summary
        run: |
          cat > webflow-summary.txt << 'EOF'
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          WEBFLOW DEPLOYMENT SUMMARY
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Commit: ${{ github.sha }}
          Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          CDN: https://cdn.jsdelivr.net/gh/tombomann/klarpakke@${{ github.sha }}/web/dist
          
          âœ… Webflow Custom Code Updated
          âœ… Site Published
          
          TEST INSTRUCTIONS:
          1. Open DevTools (F12) â†’ Console
          2. Look for: [Klarpakke] Config loaded
          3. Test pages:
             - / (landing)
             - /pricing
             - /app/dashboard
             - /kalkulator
          
          TROUBLESHOOTING:
          - Check browser console for errors
          - Verify CDN files load: check Network tab
          - If v1 API was used, consider upgrading token:
            https://developers.webflow.com/data/docs/migrating-to-v2
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          cat webflow-summary.txt

      - name: ğŸ“¤ Upload Webflow summary
        uses: actions/upload-artifact@v4
        with:
          name: webflow-summary
          path: webflow-summary.txt

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. HEALTH CHECK (sanity test)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  health-check:
    name: ğŸ® Health Check
    runs-on: ubuntu-latest
    needs: [lint-and-build, supabase-deploy, webflow-deploy]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Verify Supabase connection
        run: |
          echo "Testing Supabase connection..."
          curl -s -w "\nStatus: %{http_code}\n" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/" || echo "âš ï¸  Supabase offline check"
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5. NOTIFICATION (always run)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: ğŸ“¬ Notify Team
    runs-on: ubuntu-latest
    needs: [lint-and-build, supabase-deploy, webflow-deploy, health-check]
    if: always()
    steps:
      - name: ğŸ“Š Deployment Status
        run: |
          echo "Workflow Status: ${{ job.status }}"
          echo "Lint & Build: ${{ needs.lint-and-build.result }}"
          echo "Supabase: ${{ needs.supabase-deploy.result }}"
          echo "Webflow: ${{ needs.webflow-deploy.result }}"
          echo "Health Check: ${{ needs.health-check.result }}"
