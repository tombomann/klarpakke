name: ğŸš€ Auto-Deploy Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'web/**'
      - 'supabase/**'
      - 'scripts/deploy-*.sh'
      - 'package.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy target'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_webflow:
        description: 'Skip Webflow deployment'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  SUPABASE_CLI_VERSION: latest

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. LINT & BUILD (all branches)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint-and-build:
    name: ğŸ“‹ Lint & Build Web Assets
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ” Lint web scripts
        run: |
          echo "âœ“ Checking JS syntax..."
          node -c web/klarpakke-site.js
          node -c web/calculator.js
          node -c web/klarpakke-ui.js
          echo "âœ“ All JS files valid"

      - name: ğŸ—ï¸ Build web bundles
        run: npm run build:web

      - name: ğŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-bundles
          path: web/dist/
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. SUPABASE SETUP (database + migrations)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  supabase-deploy:
    name: ğŸ—„ï¸ Deploy Supabase (DB + Functions)
    runs-on: ubuntu-latest
    needs: lint-and-build
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Verify Supabase secrets
        run: |
          if [[ -z "$SUPABASE_ACCESS_TOKEN" ]]; then
            echo "âŒ ERROR: SUPABASE_ACCESS_TOKEN not set in Secrets"
            exit 1
          fi
          if [[ -z "${{ secrets.SUPABASE_PROJECT_REF }}" ]]; then
            echo "âŒ ERROR: SUPABASE_PROJECT_REF not set in Secrets"
            exit 1
          fi
          echo "âœ“ Secrets found"

      - name: ğŸ”§ Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”‘ Link Supabase project
        run: |
          PROJECT_REF="$(echo -n "${{ secrets.SUPABASE_PROJECT_REF }}" | tr -d '[:space:]')"
          echo "Cleaned Project Ref: ${PROJECT_REF:0:5}..."
          echo "Length: ${#PROJECT_REF} chars"
          
          if [[ ! "$PROJECT_REF" =~ ^[a-z0-9]{20}$ ]]; then
            echo "âŒ ERROR: Invalid PROJECT_REF format!"
            echo "   Expected: 20 alphanumeric characters (lowercase letters + digits)"
            echo "   Example: 'swfyuwkptusceiouqlks'"
            echo "   Got: '$PROJECT_REF' (${#PROJECT_REF} chars)"
            exit 1
          fi
          
          echo "âœ“ Project Ref validated: ${PROJECT_REF:0:5}..."
          supabase link --project-ref "$PROJECT_REF"

      - name: ğŸ“ Show pending migrations
        run: supabase migration list
        continue-on-error: true

      - name: ğŸš€ Deploy migrations
        run: |
          if [[ -d supabase/migrations ]]; then
            echo "Deploying migrations..."
            supabase db push --linked
          else
            echo "No migrations found, skipping"
          fi
        continue-on-error: true

      - name: ğŸ“¤ Deploy Edge Functions
        run: bash scripts/deploy-functions.sh
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. WEBFLOW DEPLOY (automatic via API v2/v1)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  webflow-deploy:
    name: ğŸ¨ Deploy to Webflow
    runs-on: ubuntu-latest
    needs: [lint-and-build, supabase-deploy]
    if: ${{ !inputs.skip_webflow }}
    env:
      WEBFLOW_API_TOKEN: ${{ secrets.WEBFLOW_API_TOKEN }}
      WEBFLOW_SITE_ID: ${{ secrets.WEBFLOW_SITE_ID }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ“š Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ğŸ“¥ Download web bundles
        uses: actions/download-artifact@v4
        with:
          name: web-bundles
          path: web/dist/

      - name: ğŸ” Verify Webflow secrets
        run: |
          if [[ -z "$WEBFLOW_API_TOKEN" ]]; then
            echo "âŒ ERROR: WEBFLOW_API_TOKEN not set in Secrets"
            exit 1
          fi
          if [[ -z "$WEBFLOW_SITE_ID" ]]; then
            echo "âŒ ERROR: WEBFLOW_SITE_ID not set in Secrets"
            exit 1
          fi
          echo "âœ“ Webflow secrets OK"

      - name: ğŸš€ Deploy to Webflow (v2 with v1 fallback)
        run: |
          set -e
          
          echo "ğŸ¨ Generating Webflow loader..."
          
          # Generate inline loader
          LOADER_HTML=$(cat <<'LOADER_EOF'
          <script>
          // Klarpakke Auto-Loader v2 (CI/CD)
          // Deployed: $(date -u "+%Y-%m-%d %H:%M:%S UTC")
          // Commit: ${{ github.sha }}
          
          (function() {
            'use strict';
            
            window.KLARPAKKE_CONFIG = {
              supabaseUrl: '${{ secrets.SUPABASE_URL }}',
              supabaseAnonKey: '${{ secrets.SUPABASE_ANON_KEY }}',
              version: '${{ github.sha }}',
              debug: false
            };
            
            console.log('[Klarpakke] Config loaded', window.KLARPAKKE_CONFIG.version);
            
            const CDN_BASE = 'https://cdn.jsdelivr.net/gh/tombomann/klarpakke@${{ github.sha }}/web/dist';
            
            // Load main site script
            const mainScript = document.createElement('script');
            mainScript.src = CDN_BASE + '/klarpakke-site.js';
            mainScript.async = true;
            mainScript.onload = () => console.log('[Klarpakke] Main script loaded');
            mainScript.onerror = () => console.error('[Klarpakke] Failed to load main script');
            document.body.appendChild(mainScript);
            
            // Load calculator (only if on /kalkulator page)
            if (window.location.pathname.includes('/kalkulator')) {
              const calcScript = document.createElement('script');
              calcScript.src = CDN_BASE + '/calculator.js';
              calcScript.async = true;
              calcScript.onload = () => console.log('[Klarpakke] Calculator loaded');
              calcScript.onerror = () => console.error('[Klarpakke] Failed to load calculator');
              document.body.appendChild(calcScript);
            }
          })();
          </script>
          LOADER_EOF
          )
          
          echo "ğŸ“¤ Attempting Webflow API v2 deployment..."
          
          LOADER_JSON=$(printf '%s' "$LOADER_HTML" | jq -Rs '.')
          
          # v2 API payload
          V2_PAYLOAD=$(cat <<EOF
          {
            "scripts": [
              {
                "location": "footer",
                "code": ${LOADER_JSON}
              }
            ]
          }
          EOF
          )
          
          # Try v2 API first
          V2_RESPONSE=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" -X PUT \
            "https://api.webflow.com/v2/sites/${WEBFLOW_SITE_ID}/custom_code" \
            -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$V2_PAYLOAD" 2>&1) || true
          
          HTTP_CODE=$(echo "$V2_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
          RESPONSE_BODY=$(echo "$V2_RESPONSE" | sed '/HTTP_STATUS:/d')
          
          # Check if v2 succeeded
          if [[ "$HTTP_CODE" == "200" ]] && echo "$RESPONSE_BODY" | jq -e '.id' > /dev/null 2>&1; then
            echo "âœ… Custom Code updated via API v2"
            API_VERSION="v2"
          # Check if it's an authorization error (v1 token being used)
          elif [[ "$HTTP_CODE" == "401" ]] || [[ "$HTTP_CODE" == "403" ]] || echo "$RESPONSE_BODY" | grep -iq "not authorized.*version"; then
            echo "âš ï¸  v2 API not authorized (likely using v1 token)"
            echo "ğŸ”„ Falling back to API v1..."
            
            # v1 API payload (different structure)
            V1_PAYLOAD=$(cat <<EOF
          {
            "customCode": {
              "footer": ${LOADER_JSON}
            }
          }
          EOF
            )
            
            # Try v1 API
            V1_RESPONSE=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" -X PUT \
              "https://api.webflow.com/sites/${WEBFLOW_SITE_ID}/custom-code" \
              -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -H "accept-version: 1.0.0" \
              -d "$V1_PAYLOAD" 2>&1)
            
            V1_HTTP_CODE=$(echo "$V1_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
            V1_RESPONSE_BODY=$(echo "$V1_RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [[ "$V1_HTTP_CODE" == "200" ]]; then
              echo "âœ… Custom Code updated via API v1 (legacy)"
              echo "âš ï¸  RECOMMENDATION: Migrate to v2 Site Token"
              echo "   See: https://developers.webflow.com/data/docs/migrating-to-v2"
              API_VERSION="v1"
            else
              echo "âŒ Both v2 and v1 API calls failed"
              echo "v2 Response ($HTTP_CODE): $RESPONSE_BODY"
              echo "v1 Response ($V1_HTTP_CODE): $V1_RESPONSE_BODY"
              exit 1
            fi
          else
            echo "âŒ Unexpected error from Webflow API v2 (HTTP $HTTP_CODE):"
            echo "$RESPONSE_BODY" | jq -r '.message // .' || echo "$RESPONSE_BODY"
            exit 1
          fi
          
          echo ""
          echo "ğŸ“£ Publishing Webflow site..."
          
          # Publish (try v2 first, then v1)
          if [[ "$API_VERSION" == "v2" ]]; then
            PUBLISH_RESPONSE=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" -X POST \
              "https://api.webflow.com/v2/sites/${WEBFLOW_SITE_ID}/publish" \
              -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{"domains": ["*.webflow.io"]}' 2>&1)
            
            PUB_HTTP_CODE=$(echo "$PUBLISH_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
            PUB_BODY=$(echo "$PUBLISH_RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [[ "$PUB_HTTP_CODE" == "200" ]] && echo "$PUB_BODY" | jq -e '.publishedAt' > /dev/null 2>&1; then
              PUBLISHED_AT=$(echo "$PUB_BODY" | jq -r '.publishedAt')
              echo "âœ… Site published (v2) at: $PUBLISHED_AT"
            else
              echo "âš ï¸  Publish may have failed (v2):"
              echo "$PUB_BODY" | jq -r '.message // .' || echo "$PUB_BODY"
            fi
          else
            # v1 publish
            PUBLISH_RESPONSE=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" -X POST \
              "https://api.webflow.com/sites/${WEBFLOW_SITE_ID}/publish" \
              -H "Authorization: Bearer ${WEBFLOW_API_TOKEN}" \
              -H "accept-version: 1.0.0" 2>&1)
            
            PUB_HTTP_CODE=$(echo "$PUBLISH_RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
            PUB_BODY=$(echo "$PUBLISH_RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [[ "$PUB_HTTP_CODE" == "200" ]] && echo "$PUB_BODY" | grep -q '"queued":true'; then
              echo "âœ… Site published (v1 - queued)"
            else
              echo "âš ï¸  Publish response (v1): $PUB_BODY"
            fi
          fi

      - name: ğŸ“Š Generate Webflow Summary
        run: |
          cat > webflow-summary.txt << 'EOF'
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          WEBFLOW DEPLOYMENT SUMMARY
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Commit: ${{ github.sha }}
          Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          CDN: https://cdn.jsdelivr.net/gh/tombomann/klarpakke@${{ github.sha }}/web/dist
          
          âœ… Webflow Custom Code Updated
          âœ… Site Published to *.webflow.io
          
          TEST INSTRUCTIONS:
          1. Open DevTools (F12) â†’ Console
          2. Look for: [Klarpakke] Config loaded
          3. Test pages:
             - / (landing)
             - /pricing
             - /app/dashboard
             - /kalkulator
          
          MIGRATION NOTICE:
          If you see "API v1 (legacy)" above, consider upgrading to v2 token:
          https://developers.webflow.com/data/docs/migrating-to-v2
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          cat webflow-summary.txt

      - name: ğŸ“¤ Upload Webflow summary
        uses: actions/upload-artifact@v4
        with:
          name: webflow-summary
          path: webflow-summary.txt

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. HEALTH CHECK (sanity test)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  health-check:
    name: ğŸ® Health Check
    runs-on: ubuntu-latest
    needs: [lint-and-build, supabase-deploy, webflow-deploy]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Verify Supabase connection
        run: |
          echo "Testing Supabase connection..."
          curl -s -w "\nStatus: %{http_code}\n" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/" || echo "âš ï¸  Supabase offline check"
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5. NOTIFICATION (always run)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: ğŸ“¬ Notify Team
    runs-on: ubuntu-latest
    needs: [lint-and-build, supabase-deploy, webflow-deploy, health-check]
    if: always()
    steps:
      - name: ğŸ“Š Deployment Status
        run: |
          echo "Workflow Status: ${{ job.status }}"
          echo "Lint & Build: ${{ needs.lint-and-build.result }}"
          echo "Supabase: ${{ needs.supabase-deploy.result }}"
          echo "Webflow: ${{ needs.webflow-deploy.result }}"
          echo "Health Check: ${{ needs.health-check.result }}"
