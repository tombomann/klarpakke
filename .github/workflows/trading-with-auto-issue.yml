name: Trading Analysis with Auto-Issue

on:
  schedule:
    # Every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:  # Manual trigger

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run Trading Analysis
        id: analysis
        continue-on-error: true
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set +e  # Don't exit on error
          python3 scripts/analyze_signals.py 2>&1 | tee analysis.log
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Create Debug Issue on Failure
        if: steps.analysis.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const log = fs.readFileSync('analysis.log', 'utf8');
            
            // Parse error from log
            const errorLines = log.split('\n').filter(line => 
              line.includes('ERROR') || 
              line.includes('Error') || 
              line.includes('Exception') ||
              line.includes('Traceback')
            );
            
            const errorSummary = errorLines.length > 0 
              ? errorLines.slice(0, 5).join('\n')
              : 'Unknown error - check logs';
            
            // Extract first error line for title
            const titleMatch = log.match(/(?:ERROR|Error|Exception):\s*(.+?)(?:\n|$)/);
            const errorTitle = titleMatch 
              ? titleMatch[1].substring(0, 100)
              : 'Trading Analysis Failed';
            
            // Workflow info
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const timestamp = new Date().toISOString();
            
            // Create detailed issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Trading Error: ${errorTitle}`,
              body: `## ðŸ”´ Automated Error Report

**Workflow:** ${context.workflow}
**Run:** [#${context.runId}](${runUrl})
**Time:** ${timestamp}
**Branch:** ${context.ref}
**Commit:** ${context.sha.substring(0, 7)}

### Error Summary
\`\`\`
${errorSummary}
\`\`\`

### Full Log
<details>
<summary>Click to expand full output</summary>

\`\`\`
${log.substring(0, 50000)}${log.length > 50000 ? '\n... (truncated)' : ''}
\`\`\`
</details>

### System Info
- **Python:** 3.11
- **OS:** Ubuntu Latest
- **Runner:** GitHub Actions

### Debugging Checklist
- [ ] Check Supabase connection
- [ ] Verify API keys are set
- [ ] Review signal data format
- [ ] Check database schema
- [ ] Test locally with: \`python3 scripts/analyze_signals.py\`

### Quick Fix Commands
\`\`\`bash
cd ~/klarpakke
git pull
source .env.migration
export SUPABASE_PROJECT_ID SUPABASE_SERVICE_ROLE_KEY
python3 scripts/debug-aisignal.py
python3 scripts/analyze_signals.py
\`\`\`

---
*This issue was created automatically by [GitHub Actions](${runUrl})*
*Exit code: ${context.payload.exit_code || 'unknown'}*
`,
              labels: ['bug', 'automated', 'trading-error', 'needs-triage'],
              assignees: ['tombomann']
            });
            
            console.log(`âœ… Created issue #${issue.data.number}: ${issue.data.html_url}`);
      
      - name: Report Success
        if: steps.analysis.outputs.exit_code == '0'
        run: |
          echo "âœ… Trading analysis completed successfully!"
          echo "Exit code: ${{ steps.analysis.outputs.exit_code }}"
